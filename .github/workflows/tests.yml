name: Run Tests

on:
  push:
    branches: [ main, master, feat/*, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction
    
    - name: Install Jing (RelaxNG validator)
      run: |
        wget -q https://github.com/relaxng/jing-trang/releases/download/V20220510/jing-20220510.zip
        unzip -q jing-20220510.zip
        sudo mv jing-20220510/bin/jing.jar /usr/local/bin/
        echo '#!/bin/bash' | sudo tee /usr/local/bin/jing > /dev/null
        echo 'java -jar /usr/local/bin/jing.jar "$@"' | sudo tee -a /usr/local/bin/jing > /dev/null
        sudo chmod +x /usr/local/bin/jing
        jing -version || echo "Jing installed"
    
    - name: Run tests with coverage
      run: |
        poetry run coverage run -m unittest discover -s opensiddur/tests -v
        poetry run coverage report -m
        poetry run coverage xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

